{% extends "base.html" %}
{% load static %}
{% load app_tags %}

{% block title %}
  Statistics - Yamtrack
{% endblock title %}

{% block container %}
  <div class="py-4">

    <!-- Statistics Section Header -->
    <div class="row mb-3">
      <div class="col">
        <h4 class="text-light">Period Statistics</h4>
      </div>
    </div>

    <div class="card bg-foreground mb-5">
      <div class="card-body">
        <h5 class="card-title mb-3">Select Date Range</h5>
        <form class="row g-3">
          <!-- Predefined Ranges -->
          <div class="col-md-4">
            <label class="form-label">Predefined Ranges</label>
            <select class="form-select" id="predefined-range">
              <option value="">Custom Range</option>
              <option value="today">Today</option>
              <option value="yesterday">Yesterday</option>
              <option value="thisWeek">This Week</option>
              <option value="lastWeek">Last Week</option>
              <option value="thisMonth">This Month</option>
              <option value="lastMonth">Last Month</option>
              <option value="thisYear">This Year</option>
              <option value="lastYear">Last Year</option>
              <option value="allTime">All Time</option>
            </select>
          </div>
          <!-- Custom Date Range -->
          <div class="col-md-8">
            <div class="row g-3">
              <div class="col-6">
                <label class="form-label">Start Date</label>
                <input type="date"
                       class="form-control"
                       id="start-date"
                       name="start-date"
                       value="{{ start_date|date:"Y-m-d" }}">
              </div>
              <div class="col-6">
                <label class="form-label">End Date</label>
                <input type="date"
                       class="form-control"
                       id="end-date"
                       name="end-date"
                       value="{{ end_date|date:"Y-m-d" }}">
              </div>
            </div>
          </div>
          <!-- Apply Button -->
          <div class="col-12 text-center">
            <button class="btn btn-primary" type="submit">Apply Range</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Activity History Section -->
    <div class="card bg-foreground mb-5">
      <div class="card-body">
        <h5 class="card-title mb-4 text-center">Activity History</h5>
        <div class="d-flex w-100 overflow-x-scroll overflow-y-hidden">
          <div class="contribution-graph">
            <!-- Months row -->
            <div class="d-flex mb-1 months gap-1">
              {% for month, week_count in month_data %}
                <div class="month small text-secondary"
                     style="width: calc(({{ week_count }} * var(--square-size)) + (({{ week_count }} - 1) * var(--gap-size)))">
                  {{ month }}
                </div>
              {% endfor %}
            </div>

            <!-- Graph wrapper -->
            <div class="d-flex gap-1">
              <!-- Weekday labels -->
              <div class="d-flex flex-column gap-1 pe-2">
                {% for weekday in weekdays %}
                  {% if forloop.counter0|divisibleby:2 %}
                    <div class="weekday-label small text-secondary">{{ weekday }}</div>
                  {% else %}
                    <div class="weekday-label"></div>
                  {% endif %}
                {% endfor %}
              </div>

              <!-- Weeks grid -->
              <div class="d-flex gap-1">
                {% for week in calendar_weeks %}
                  <div class="d-flex flex-column gap-1">
                    {% for day in week %}
                      <div class="day"
                           data-level="{{ day.level }}"
                           data-bs-toggle="tooltip"
                           data-bs-title="{{ day.count }} action{{ day.count|pluralize }} on {{ day.date }}"></div>
                    {% endfor %}
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Overview Stats -->
    <div class="row g-4 mb-4">
      <div class="col-md-6 col-lg-3">
        <div class="card bg-foreground h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-body-secondary">Total Items Completed</h6>
            <h2 class="card-title mb-2">{{ status_distribution.total_completed }}</h2>
            <p class="card-text text-body-secondary mb-0">From {{ media_count.total }} items</p>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card bg-foreground h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-body-secondary">Average Rating</h6>
            <h2 class="card-title mb-2">{{ score_distribution.average_score }}</h2>
            <p class="card-text text-body-secondary mb-0">
              From {{ score_distribution.total_scored }} rated item{{ score_distribution.total_scored|pluralize }}
            </p>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card bg-foreground h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-body-secondary">Most Active Day</h6>
            <h2 class="card-title mb-2">Sunday</h2>
            <p class="card-text text-body-secondary mb-0">42% of activity</p>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card bg-foreground h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-body-secondary">Time Spent</h6>
            <h2 class="card-title mb-2">463h</h2>
            <p class="card-text text-danger mb-0">
              <i class="bi bi-arrow-down"></i> 5% from previous period
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-lg-6">
        <div class="card bg-foreground h-100">
          <div class="card-body">
            <h5 class="card-title mb-4">Media Type Distribution</h5>

            {% for media_type, count in media_count.items %}
              {% if media_type != "total" %}
                {% widthratio count media_count.total 100 as width %}
                <div class="mb-4">
                  <div class="d-flex justify-content-between mb-1">
                    <span>{{ media_type|media_type_readable }}</span>
                    <span>{{ count }}</span>
                  </div>
                  <div class="progress" role="progressbar">
                    <div class="progress-bar"
                         style="width: {{ width }}%;
                                background-color: {{ media_type|media_color }}"></div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card bg-foreground h-100">
          <div class="card-body">
            <h5 class="card-title mb-4">Status Distribution</h5>

            {% for status in status_distribution.datasets %}
              {% widthratio status.total media_count.total 100 as ratio %}
              <div class="mb-4">
                <div class="d-flex justify-content-between mb-1">
                  <span>{{ status.label }}</span>
                  <span>{{ status.total }} ({{ ratio }}%)</span>
                </div>
                <div class="progress" role="progressbar">
                  <div class="progress-bar"
                       style="width: {{ ratio }}%;
                              background-color: {{ status.background_color }}"></div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="card bg-foreground mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3 text-center">Media Status Distribution</h5>
        <div class="chart">
          <canvas id="statusDistribution"></canvas>
        </div>
      </div>
    </div>

    <div class="card bg-foreground mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3 text-center">Media Score Distribution</h5>
        <div class="chart">
          <canvas id="scoreDistribution"></canvas>
        </div>
      </div>
    </div>

    {% if score_distribution.highest_rated %}
      <div class="card bg-foreground mb-5">
        <div class="card-body">
          <div class="row g-4">
            <div class="col-3">
              <h4 class="text-center">Highest Rated</h4>

              <div class="card media-card">
                <img src="{{ score_distribution.highest_rated.image }}"
                     class="card-img {% if score_distribution.highest_rated.image == IMG_NONE %}image-not-found{% else %}poster{% endif %}"
                     alt="{{ score_distribution.highest_rated.title }}" />

                <div class="card-img-overlay">
                  <div class="card-title">{{ score_distribution.highest_rated.score }}</div>
                </div>
              </div>
            </div>

            <div class="col-3">
              <h4 class="text-center">Highest Rated</h4>

              <div class="card media-card">
                <img src="{{ score_distribution.highest_rated.image }}"
                     class="card-img {% if score_distribution.highest_rated.image == IMG_NONE %}image-not-found{% else %}poster{% endif %}"
                     alt="{{ score_distribution.highest_rated.title }}" />

                <div class="card-img-overlay">
                  <div class="card-title">{{ score_distribution.highest_rated.score }}</div>
                </div>
              </div>
            </div>

            <div class="col-3">
              <h4 class="text-center">Highest Rated</h4>

              <div class="card media-card">
                <img src="{{ score_distribution.highest_rated.image }}"
                     class="card-img {% if score_distribution.highest_rated.image == IMG_NONE %}image-not-found{% else %}poster{% endif %}"
                     alt="{{ score_distribution.highest_rated.title }}" />

                <div class="card-img-overlay">
                  <div class="card-title">{{ score_distribution.highest_rated.score }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock container %}

{% block js %}
  <script src="{% static 'js/jquery.min.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="{% static 'js/date-range.js' %}"></script>

  {% comment %} Enable bootstrap tooltips {% endcomment %}
  <script>
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
  </script>
  {{ status_distribution|json_script:"status_distribution" }}
  {{ score_distribution|json_script:"score_distribution" }}

  <script>
    function createStackedBarChart(elementId, dataElementId) {
      const ctx = document.getElementById(elementId);
      const chartData = JSON.parse(document.getElementById(dataElementId).textContent);
  
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: chartData.labels,
          datasets: chartData.datasets.map((dataset) => ({
            label: dataset.label,
            data: dataset.data,
            backgroundColor: dataset.background_color,
            borderWidth: 2
          }))
        },
        options: {
          maintainAspectRatio: false,
          responsive: true,
          scales: {
            x: {
              stacked: true,
            },
            y: {
              stacked: true,
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
  
    document.addEventListener('DOMContentLoaded', function() {
      createStackedBarChart('statusDistribution', 'status_distribution');
      createStackedBarChart('scoreDistribution', 'score_distribution');
    });
  </script>
  <script>
    function updateJustification(containerSelector = '.overflow-x-scroll') {
      const container = document.querySelector(containerSelector);
      if (!container) {
          console.warn('Container not found');
          return;
      }
  
      // Check if content is wider than container
      const hasOverflow = container.scrollWidth > container.clientWidth;
  
      if (hasOverflow) {
        console.log('Overflow detected');
          container.classList.remove('justify-content-center');
          container.classList.add('justify-content-start');
      } else {
        console.log('No overflow');
          container.classList.remove('justify-content-start');
          container.classList.add('justify-content-center');
      }
  }
  
  // Initial check
  document.addEventListener('DOMContentLoaded', () => {
      updateJustification();
  });
  
  // Update on window resize
  window.addEventListener('resize', () => {
      updateJustification();
  });
  </script>
{% endblock js %}
