{% extends "base.html" %}
{% load static %}
{% load app_tags %}

{% block title %}
  Statistics - Yamtrack
{% endblock title %}

{% block container %}
  <div class="py-4">

    <!-- Activity Section Header -->
    <div class="row mb-3">
      <div class="col">
        <h4 class="text-light">Annual Activity History</h4>
      </div>
    </div>
    <!-- Activity History Section -->
    <div class="card bg-foreground mb-5">
      <div class="card-body">
        <div class="d-flex justify-content-start justify-content-xxl-center w-100 overflow-x-scroll overflow-y-hidden">
          <div class="contribution-graph">
            <!-- Months row -->
            <div class="d-flex mb-1 months gap-1">
              {% for month, week_count in month_data %}
                <div class="month small text-secondary"
                     style="width: calc(({{ week_count }} * var(--square-size)) + (({{ week_count }} - 1) * var(--gap-size)))">
                  {{ month }}
                </div>
              {% endfor %}
            </div>

            <!-- Graph wrapper -->
            <div class="d-flex gap-1">
              <!-- Weekday labels -->
              <div class="d-flex flex-column gap-1 pe-2">
                {% for weekday in weekdays %}
                  {% if forloop.counter0|divisibleby:2 %}
                    <div class="weekday-label small text-secondary">{{ weekday }}</div>
                  {% else %}
                    <div class="weekday-label"></div>
                  {% endif %}
                {% endfor %}
              </div>

              <!-- Weeks grid -->
              <div class="d-flex gap-1">
                {% for week in calendar_weeks %}
                  <div class="d-flex flex-column gap-1">
                    {% for day in week %}
                      <div class="day"
                           data-level="{{ day.level }}"
                           data-bs-toggle="tooltip"
                           data-bs-title="{{ day.count }} action{{ day.count|pluralize }} on {{ day.date }}"></div>
                    {% endfor %}
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistics Section Header -->
    <div class="row mb-3">
      <div class="col">
        <h4 class="text-light">Period Statistics</h4>
      </div>
    </div>

    <div class="card bg-foreground mb-5">
      <div class="card-body">
        <h5 class="card-title mb-3">Select Date Range</h5>
        <form class="row g-3">
          <!-- Predefined Ranges -->
          <div class="col-md-4">
            <label class="form-label">Predefined Ranges</label>
            <select class="form-select" id="predefined-range">
              <option value="">Custom Range</option>
              <option value="today">Today</option>
              <option value="yesterday">Yesterday</option>
              <option value="thisWeek">This Week</option>
              <option value="lastWeek">Last Week</option>
              <option value="thisMonth">This Month</option>
              <option value="lastMonth">Last Month</option>
              <option value="thisYear">This Year</option>
              <option value="lastYear">Last Year</option>
              <option value="allTime">All Time</option>
            </select>
          </div>
          <!-- Custom Date Range -->
          <div class="col-md-8">
            <div class="row g-3">
              <div class="col-6">
                <label class="form-label">Start Date</label>
                <input type="date"
                       class="form-control"
                       id="start-date"
                       name="start-date"
                       value="{{ start_date|date:"Y-m-d" }}">
              </div>
              <div class="col-6">
                <label class="form-label">End Date</label>
                <input type="date"
                       class="form-control"
                       id="end-date"
                       name="end-date"
                       value="{{ end_date|date:"Y-m-d" }}">
              </div>
            </div>
          </div>
          <!-- Apply Button -->
          <div class="col-12 text-center">
            <button class="btn btn-primary" type="submit">Apply Range</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Overview Stats -->
    <div class="row g-4 mb-4">
      <div class="col-md-6 col-lg-3">
        <div class="card bg-foreground h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-body-secondary">Total Items Completed</h6>
            <h2 class="card-title mb-2">{{ status_distribution.total_completed }}</h2>
            <p class="card-text text-body-secondary mb-0">From {{ media_count.total }} items</p>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card bg-foreground h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-body-secondary">Average Rating</h6>
            <h2 class="card-title mb-2">{{ score_distribution.average_score }}</h2>
            <p class="card-text text-body-secondary mb-0">
              From {{ score_distribution.total_scored }} rated item{{ score_distribution.total_scored|pluralize }}
            </p>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card bg-foreground h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-body-secondary">Most Active Day</h6>
            <h2 class="card-title mb-2">Sunday</h2>
            <p class="card-text text-body-secondary mb-0">42% of activity</p>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card bg-foreground h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-body-secondary">Time Spent</h6>
            <h2 class="card-title mb-2">463h</h2>
            <p class="card-text text-danger mb-0">
              <i class="bi bi-arrow-down"></i> 5% from previous period
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-lg-6">
        <div class="card bg-foreground h-100">
          <div class="card-body">
            <h5 class="card-title mb-4">Media Type Distribution</h5>

            {% for media_type, count in media_count.items %}
              {% if media_type != "total" %}
                {% widthratio count media_count.total 100 as width %}
                <div class="mb-4">
                  <div class="d-flex justify-content-between mb-1">
                    <span>{{ media_type|media_type_readable }}</span>
                    <span>{{ count }}</span>
                  </div>
                  <div class="progress" role="progressbar">
                    <div class="progress-bar"
                         style="width: {{ width }}%;
                                background-color: {{ media_type|media_color }}"></div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card bg-foreground h-100">
          <div class="card-body">
            <h5 class="card-title mb-4">Status Distribution</h5>
            <div class="mb-4">
              <div class="d-flex justify-content-between mb-1">
                <span>Completed</span>
                <span>65%</span>
              </div>
              <div class="progress" role="progressbar">
                <div class="progress-bar bg-success" style="width: 65%"></div>
              </div>
            </div>
            <div class="mb-4">
              <div class="d-flex justify-content-between mb-1">
                <span>In Progress</span>
                <span>15%</span>
              </div>
              <div class="progress" role="progressbar">
                <div class="progress-bar bg-info" style="width: 15%"></div>
              </div>
            </div>
            <div class="mb-4">
              <div class="d-flex justify-content-between mb-1">
                <span>Planning</span>
                <span>12%</span>
              </div>
              <div class="progress" role="progressbar">
                <div class="progress-bar bg-warning" style="width: 12%"></div>
              </div>
            </div>
            <div class="mb-4">
              <div class="d-flex justify-content-between mb-1">
                <span>Dropped</span>
                <span>8%</span>
              </div>
              <div class="progress" role="progressbar">
                <div class="progress-bar bg-danger" style="width: 8%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card bg-foreground mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3 text-center">Status Distribution</h5>
        <div class="chart">
          <canvas id="statusDistribution"></canvas>
        </div>
      </div>
    </div>

    <div class="card bg-foreground mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3 text-center">Score Distribution</h5>
        <div class="chart">
          <canvas id="scoreDistribution"></canvas>
        </div>
      </div>
    </div>

    {% if score_distribution.highest_rated %}
      <div class="card bg-foreground mb-5">
        <div class="card-body">
          <div class="row g-4">
            <div class="col-3">
              <h4 class="text-center">Highest Rated</h4>

              <div class="card media-card">
                <img src="{{ score_distribution.highest_rated.image }}"
                     class="card-img {% if score_distribution.highest_rated.image == IMG_NONE %}image-not-found{% else %}poster{% endif %}"
                     alt="{{ score_distribution.highest_rated.title }}" />

                <div class="card-img-overlay">
                  <div class="card-title">{{ score_distribution.highest_rated.score }}</div>
                </div>
              </div>
            </div>

            <div class="col-3">
              <h4 class="text-center">Highest Rated</h4>

              <div class="card media-card">
                <img src="{{ score_distribution.highest_rated.image }}"
                     class="card-img {% if score_distribution.highest_rated.image == IMG_NONE %}image-not-found{% else %}poster{% endif %}"
                     alt="{{ score_distribution.highest_rated.title }}" />

                <div class="card-img-overlay">
                  <div class="card-title">{{ score_distribution.highest_rated.score }}</div>
                </div>
              </div>
            </div>

            <div class="col-3">
              <h4 class="text-center">Highest Rated</h4>

              <div class="card media-card">
                <img src="{{ score_distribution.highest_rated.image }}"
                     class="card-img {% if score_distribution.highest_rated.image == IMG_NONE %}image-not-found{% else %}poster{% endif %}"
                     alt="{{ score_distribution.highest_rated.title }}" />

                <div class="card-img-overlay">
                  <div class="card-title">{{ score_distribution.highest_rated.score }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock container %}

{% block js %}
  <script src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="{% static 'js/date-range.js' %}"></script>

  {% comment %} Enable bootstrap tooltips {% endcomment %}
  <script>
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
  </script>

  {{ status_distribution|json_script:"status_distribution" }};
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const ctx = document.getElementById('statusDistribution');
      const statusData = JSON.parse(document.getElementById('status_distribution').textContent);
  
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: statusData.labels,
          datasets: statusData.datasets.map((dataset, index) => ({
              label: dataset.label,
              data: dataset.data,
              backgroundColor: getStatusColor(dataset.label),
              borderWidth: 1
          }))
        },
        options: {
          maintainAspectRatio: false,
          responsive: true,
          scales: {
            x: {
              stacked: true,
            },
            y: {
              stacked: true,
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              position: 'bottom'
            }
        }
        }
      });
    });
    
    function getStatusColor(status) {
      const colors = {
        'In progress': 'rgba(54, 162, 235, 0.8)',
        'Completed': 'rgba(75, 192, 192, 0.8)',
        'Repeating': 'rgba(153, 102, 255, 0.8)',
        'Planning': 'rgba(255, 206, 86, 0.8)',
        'Paused': 'rgba(255, 159, 64, 0.8)',
        'Dropped': 'rgba(255, 99, 132, 0.8)'
      };
      return colors[status] || 'rgba(201, 203, 207, 0.8)';
    }
  </script>

  {{ score_distribution|json_script:"score_distribution" }};
  {% media_colors_js %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const ctx = document.getElementById('scoreDistribution');
      const scoreData = JSON.parse(document.getElementById('score_distribution').textContent);
  
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: scoreData.labels,
          datasets: scoreData.datasets.map((dataset, index) => ({
              label: dataset.label,
              data: dataset.data,
              backgroundColor: getMediaTypeColor(dataset.label),
              borderWidth: 1
          }))
        },
        options: {
          maintainAspectRatio: false,
          responsive: true,
          scales: {
            x: {
              stacked: true,
            },
            y: {
              stacked: true,
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              position: 'bottom'
            }
        }
        }
      });
    });
  </script>
{% endblock js %}
