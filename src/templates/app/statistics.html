{% extends "base.html" %}
{% load static %}

{% block css %}
  <link rel="stylesheet"
        type="text/css"
        href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
  <link rel="stylesheet" type="text/css" href="{% static "css/daterangepicker-bootstrap-dark.css" %}" />
{% endblock css %}

{% block title %}
  Statistics - Yamtrack
{% endblock title %}

{% block container %}
  <div class="d-flex flex-column align-items-center">

    <h2 class="mb-3">Activity History</h2>
    <div class="d-flex justify-content-start justify-content-xxl-center w-100 overflow-x-scroll overflow-y-hidden">
      <div class="contribution-graph">
        <!-- Months row -->
        <div class="d-flex mb-1 months gap-1">
          {% for month, week_count in month_data %}
            <div class="month small text-secondary"
                 style="width: calc(({{ week_count }} * var(--square-size)) + (({{ week_count }} - 1) * var(--gap-size)))">
              {{ month }}
            </div>
          {% endfor %}
        </div>

        <!-- Graph wrapper -->
        <div class="d-flex gap-1">
          <!-- Weekday labels -->
          <div class="d-flex flex-column gap-1 pe-2">
            {% for weekday in weekdays %}
              {% if forloop.counter0|divisibleby:2 %}
                <div class="weekday-label small text-secondary">{{ weekday }}</div>
              {% else %}
                <div class="weekday-label"></div>
              {% endif %}
            {% endfor %}
          </div>

          <!-- Weeks grid -->
          <div class="d-flex gap-1">
            {% for week in calendar_weeks %}
              <div class="d-flex flex-column gap-1">
                {% for day in week %}
                  <div class="day"
                       data-level="{{ day.level }}"
                       data-bs-toggle="tooltip"
                       data-bs-title="{{ day.count }} action{{ day.count|pluralize }} on {{ day.date }}"></div>
                {% endfor %}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <h2 class="mt-5 mb-3">Statistics</h2>
    <form class="input-group date-range-stats mb-5">
      <input type="text" class="form-control text-center" name="date-range">
      <button class="btn btn-secondary" type="submit">View</button>
    </form>

    <div class="d-flex w-100 flex-wrap">

      <div class="w-100 mb-5 chart">
        <canvas id="statusDistribution"></canvas>
      </div>

      {% if highest_scored %}
        <div>
          <h3 class="text-center">Highest Rated</h3>

          <div class="card">
            <img src="{{ highest_scored.item.image }}"
                 class="card-img {% if highest_scored.item.image == IMG_NONE %}image-not-found{% else %}poster{% endif %}"
                 alt="{{ highest_scored.item.title }}" />

            <div class="card-img-overlay">
              <div class="card-title">{{ highest_scored.score }}</div>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

{% endblock container %}

{% block js %}
  <script src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  <script src="{% static 'js/date-range.js' %}"></script>

  {% comment %} Enable bootstrap tooltips {% endcomment %}
  <script>
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
  </script>

  {{ status_distribution|json_script:"status_distribution" }};

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const ctx = document.getElementById('statusDistribution');
      const statusData = JSON.parse(document.getElementById('status_distribution').textContent);
  
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: statusData.labels,
          datasets: statusData.datasets.map((dataset, index) => ({
              label: dataset.label,
              data: dataset.data,
              backgroundColor: getStatusColor(dataset.label),
              borderWidth: 1
          }))
        },
        options: {
          maintainAspectRatio: false,
          responsive: true,
          scales: {
            x: {
              stacked: true,
            },
            y: {
              stacked: true,
              beginAtZero: true
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Media Status Distribution'
            },
            legend: {
              position: 'bottom'
            }
        }
        }
      });
    });
    
    function getStatusColor(status) {
      const colors = {
        'In progress': 'rgba(54, 162, 235, 0.8)',
        'Completed': 'rgba(75, 192, 192, 0.8)',
        'Repeating': 'rgba(153, 102, 255, 0.8)',
        'Planning': 'rgba(255, 206, 86, 0.8)',
        'Paused': 'rgba(255, 159, 64, 0.8)',
        'Dropped': 'rgba(255, 99, 132, 0.8)'
      };
      return colors[status] || 'rgba(201, 203, 207, 0.8)';
    }
  </script>
{% endblock js %}
